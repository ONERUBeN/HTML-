<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Symbiosis Architect</title>
    <!-- Telegram API -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- PixiJS Graphics Engine -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/7.3.3/pixi.min.js"></script>
    <!-- Pixi Filters (Bloom) -->
    <script src="https://cdn.jsdelivr.net/npm/pixi-filters@5.3.0/dist/pixi-filters.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');

        body { 
            margin: 0; overflow: hidden; background: #010103; 
            font-family: 'Share Tech Mono', monospace; color: white;
            user-select: none; -webkit-tap-highlight-color: transparent;
        }

        #ui { position: absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:10; }

        /* HUD */
        .hud-panel {
            position: absolute; top: 15px; left: 15px; right: 15px;
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(0, 20, 40, 0.8); 
            border-bottom: 2px solid #00ffcc;
            padding: 10px; border-radius: 4px;
            backdrop-filter: blur(4px);
            box-shadow: 0 0 20px rgba(0,255,204,0.15);
        }
        
        .neon-txt { color: #00ffcc; text-shadow: 0 0 8px #00ffcc; font-size: 18px; }
        .label { font-size: 10px; color: #888; letter-spacing: 1px; }

        /* CONTROLS */
        .controls-layer {
            position: absolute; bottom: 30px; width: 100%; height: 150px;
            pointer-events: none; display: flex; justify-content: space-between; padding: 0 30px; box-sizing: border-box;
        }

        .fab {
            width: 70px; height: 70px; border-radius: 15px;
            background: rgba(0, 15, 30, 0.9); border: 1px solid #444;
            color: #fff; font-size: 24px;
            display: flex; align-items: center; justify-content: center;
            pointer-events: auto; transition: 0.1s; backdrop-filter: blur(4px);
        }
        .fab:active { transform: scale(0.9); border-color: #fff; }
        
        .fab-main { 
            width: 85px; height: 85px; font-size: 30px;
            border-color: #00ffcc; color: #00ffcc;
            box-shadow: 0 0 25px rgba(0,255,204,0.25);
            background: radial-gradient(circle, rgba(0,255,204,0.1) 0%, rgba(0,10,20,0.9) 80%);
        }
        
        #stick-zone {
            width: 120px; height: 120px;
            border: 1px dashed rgba(255,255,255,0.15);
            border-radius: 50%; position: relative; pointer-events: auto;
            background: rgba(255,255,255,0.02);
        }
        #stick {
            width: 50px; height: 50px; background: rgba(0,255,204,0.2);
            border: 2px solid #00ffcc; border-radius: 50%;
            position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%);
            box-shadow: 0 0 10px rgba(0,255,204,0.3);
        }

        /* HACKING MINIGAME OVERLAY */
        #hack-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 100;
            display: none; flex-direction: column; justify-content: center; align-items: center;
            pointer-events: auto; backdrop-filter: blur(5px);
        }
        
        .hack-window {
            width: 80%; max-width: 300px;
            background: #050505; border: 2px solid #ff0055;
            padding: 20px; border-radius: 8px; text-align: center;
            box-shadow: 0 0 40px rgba(255,0,85,0.2);
        }

        .hack-track {
            width: 100%; height: 30px; background: #111; margin: 20px 0;
            position: relative; border-radius: 4px; overflow: hidden;
            border: 1px solid #333;
        }
        .hack-zone {
            position: absolute; left: 40%; width: 20%; height: 100%; 
            background: #00ffcc; opacity: 0.6;
            box-shadow: 0 0 10px #00ffcc;
        }
        .hack-cursor {
            position: absolute; left: 0; width: 4px; height: 100%; 
            background: #fff; box-shadow: 0 0 10px #fff;
        }
        
        .hack-btn {
            background: #ff0055; color: white; border: none; padding: 12px 0; width: 100%;
            font-family: inherit; font-size: 18px; font-weight: bold; cursor: pointer;
            text-transform: uppercase; letter-spacing: 2px;
            transition: 0.2s;
        }
        .hack-btn:active { background: #fff; color: #000; }

        /* NOTIFICATIONS */
        #notif {
            position: absolute; top: 100px; width: 100%; text-align: center;
            opacity: 0; transition: 0.3s; transform: translateY(20px);
        }
        .notif-box {
            display: inline-block; background: rgba(0,10,20,0.9);
            border: 1px solid #00ffcc; padding: 8px 25px; color: #00ffcc;
            border-radius: 20px; font-size: 14px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
        }

    </style>
</head>
<body>

    <div id="ui">
        <div class="hud-panel">
            <div>
                <div class="label">NEURAL LINK</div>
                <div style="font-weight:bold; letter-spacing:1px;">ARCHITECT</div>
            </div>
            <div style="text-align:right;">
                <div class="label">ENERGY</div>
                <div class="neon-txt">‚ö° <span id="uNeon">100</span></div>
            </div>
        </div>

        <div id="notif"><div class="notif-box" id="notif-text">SYSTEM ONLINE</div></div>

        <!-- HACK GAME -->
        <div id="hack-overlay">
            <div class="hack-window">
                <h2 style="margin:0; color:#ff0055; text-shadow:0 0 10px #ff0055;">SECURITY BREACH</h2>
                <div style="font-size:10px; color:#666; margin-top:5px;">LOCK ON TARGET</div>
                
                <div class="hack-track">
                    <div class="hack-zone"></div>
                    <div class="hack-cursor" id="h-cursor"></div>
                </div>
                
                <button class="hack-btn" onclick="window.tryHack()">EXECUTE</button>
            </div>
        </div>

        <div class="controls-layer">
            <div id="stick-zone"><div id="stick"></div></div>
            <div style="display:flex; gap:15px; align-items:flex-end;">
                <div class="fab" onclick="window.action('fuse')" style="border-color:#bd00ff; color:#bd00ff;">üß¨</div>
                <div class="fab fab-main" onclick="window.action('gacha')">‚ö°</div>
            </div>
        </div>
    </div>

    <script>
        // –ò–∑–æ–ª–∏—Ä—É–µ–º –∫–æ–¥ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
        (function() {
            const tg = window.Telegram.WebApp;
            tg.expand();

            // --- AUDIO ENGINE (Procedural Sound) ---
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            
            function playSound(type) {
                if(audioCtx.state === 'suspended') audioCtx.resume();
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain); gain.connect(audioCtx.destination);
                const now = audioCtx.currentTime;

                if(type === 'UI') {
                    // Click sound
                    osc.type = 'sine'; 
                    osc.frequency.setValueAtTime(800, now);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                    osc.start(now); osc.stop(now + 0.1);
                }
                else if(type === 'WIN') {
                    // Success sound
                    osc.type = 'triangle';
                    osc.frequency.setValueAtTime(200, now);
                    osc.frequency.linearRampToValueAtTime(800, now + 0.15);
                    gain.gain.linearRampToValueAtTime(0, now + 0.4);
                    osc.start(now); osc.stop(now + 0.4);
                }
                else if(type === 'FAIL') {
                    // Error sound
                    osc.type = 'sawtooth';
                    osc.frequency.setValueAtTime(150, now);
                    gain.gain.linearRampToValueAtTime(0, now + 0.4);
                    osc.start(now); osc.stop(now + 0.4);
                }
            }

            // --- PIXI ENGINE ---
            const app = new PIXI.Application({ 
                resizeTo: window, 
                backgroundColor: 0x010103, 
                antialias: false,
                resolution: window.devicePixelRatio || 1, 
                autoDensity: true
            });
            document.body.appendChild(app.view);

            // LAYERS
            const bgContainer = new PIXI.Container();
            const gameContainer = new PIXI.Container();
            const fxContainer = new PIXI.Container();
            app.stage.addChild(bgContainer, gameContainer, fxContainer);

            // --- POST-PROCESSING ---
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
            try {
                if (PIXI.filters && PIXI.filters.AdvancedBloomFilter) {
                    const bloom = new PIXI.filters.AdvancedBloomFilter({ threshold: 0.4, bloomScale: 1.2, brightness: 1.0, blur: 4 });
                    app.stage.filters = [bloom];
                }
            } catch (e) {
                console.warn("Filters load warning:", e);
            }

            // --- VISUALS: DIGITAL CITY (PARALLAX) ---
            const gridGfx = new PIXI.Graphics();
            bgContainer.addChild(gridGfx);
            
            // Generate Stars
            for(let i=0; i<50; i++) {
                const s = new PIXI.Graphics();
                s.beginFill(0xffffff, Math.random()*0.5);
                s.drawCircle(0,0, Math.random() + 0.5);
                s.x = Math.random() * app.screen.width;
                s.y = Math.random() * app.screen.height;
                bgContainer.addChild(s);
            }
            
            function drawCityGrid(offsetY) {
                gridGfx.clear();
                // Perspective Grid
                const hY = app.screen.height * 0.4;
                gridGfx.lineStyle(1, 0x004444, 0.3);
                const w = app.screen.width;
                const h = app.screen.height;
                
                // Vertical lines
                for(let x=-w; x<=w*2; x+=80) {
                    gridGfx.moveTo(w/2, hY); gridGfx.lineTo(x, h);
                }
                
                // Horizontal lines (moving)
                const step = 40;
                const startY = offsetY % step;
                for(let y=hY; y<=h; y+=step * (1 + (y-hY)/200)) {
                    const yy = y + startY;
                    if(yy > h) continue;
                    gridGfx.lineStyle(1, 0x00ffcc, (y-hY)/(h-hY)*0.5);
                    gridGfx.moveTo(0, yy); gridGfx.lineTo(w, yy);
                }
            }

            // --- PLAYER ---
            const player = new PIXI.Container();
            player.x = app.screen.width / 2;
            player.y = app.screen.height * 0.75;
            gameContainer.addChild(player);

            const drone = new PIXI.Graphics();
            drone.beginFill(0x000000); drone.lineStyle(2, 0x00ffcc);
            drone.drawPolygon([0,-20, 15,10, 0,5, -15,10]);
            drone.endFill();
            
            // Engine
            const engine = new PIXI.Graphics();
            engine.beginFill(0x00ffcc);
            engine.drawCircle(0, 10, 4);
            engine.endFill();
            
            player.addChild(engine, drone);

            // Particles System
            const particles = [];
            function spawnExhaust() {
                const p = new PIXI.Graphics();
                p.beginFill(0x00ffcc); p.drawRect(0,0,3,3);
                p.x = player.x + (Math.random()-0.5)*10;
                p.y = player.y + 15;
                p.alpha = 1; fxContainer.addChild(p); particles.push(p);
            }

            // --- LOGIC ---
            let state = { neon: 100, gridOffset: 0, speed: 2 };
            let joy = { active: false, dx: 0, dy: 0, sx: 0, sy: 0 };
            
            // Input Handlers
            const stickZone = document.getElementById('stick-zone');
            const stick = document.getElementById('stick');
            
            stickZone.addEventListener('touchstart', e=>{
                e.preventDefault(); joy.active=true; 
                joy.sx=e.touches[0].clientX; joy.sy=e.touches[0].clientY;
                if(audioCtx.state === 'suspended') audioCtx.resume();
            });
            
            window.addEventListener('touchmove', e=>{
                if(!joy.active)return;
                let t=e.touches[0], dx=t.clientX-joy.sx, dy=t.clientY-joy.sy;
                let dist=Math.min(Math.sqrt(dx*dx+dy*dy), 40);
                let ang=Math.atan2(dy,dx);
                
                stick.style.transform=`translate(calc(-50% + ${Math.cos(ang)*dist}px), calc(-50% + ${Math.sin(ang)*dist}px))`;
                joy.dx=Math.cos(ang)*(dist/40); 
                joy.dy=Math.sin(ang)*(dist/40);
                
                // Rotate drone based on turn
                drone.rotation = joy.dx * 0.5;
            });
            
            window.addEventListener('touchend', ()=>{
                joy.active=false; joy.dx=0; joy.dy=0; 
                stick.style.transform=`translate(-50%,-50%)`;
                drone.rotation = 0;
            });

            // Loop
            app.ticker.add((delta) => {
                // City Movement (Speed increases with forward input)
                const boost = joy.dy < 0 ? -joy.dy * 5 : 0;
                state.gridOffset += (state.speed + boost) * delta;
                drawCityGrid(state.gridOffset);

                // Player Movement (Left/Right)
                if(joy.active) {
                    player.x += joy.dx * 6 * delta;
                    // Clamp screen
                    if(player.x < 20) player.x = 20;
                    if(player.x > app.screen.width-20) player.x = app.screen.width-20;
                }

                // Particles Logic
                spawnExhaust();
                for(let i=particles.length-1; i>=0; i--) {
                    let p = particles[i];
                    p.y += (4 + boost) * delta; // Particles fall behind
                    p.alpha -= 0.05 * delta;
                    if(p.alpha<=0) { fxContainer.removeChild(p); particles.splice(i,1); }
                }
            });

            // --- HACKING MINIGAME LOGIC ---
            let hackPos = 0, hackDir = 2, hacking = false;
            let hackLoopRef;
            
            // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è HTML –∫–Ω–æ–ø–∫–∏
            window.tryHack = function() {
                // Success zone: 35% to 65%
                if(hackPos > 35 && hackPos < 65) {
                    playSound('WIN');
                    state.neon -= 25;
                    document.getElementById('uNeon').innerText = state.neon;
                    tg.sendData(JSON.stringify({act:'hack_success'}));
                    notify("ACCESS GRANTED. DOWNLOADING...", "#00ffcc");
                } else {
                    playSound('FAIL');
                    notify("ACCESS DENIED. TRY AGAIN.", "#ff0055");
                }
                stopHack();
            }

            function startHack() {
                hacking = true;
                document.getElementById('hack-overlay').style.display = 'flex';
                hackLoop();
            }
            
            function stopHack() {
                hacking = false;
                document.getElementById('hack-overlay').style.display = 'none';
                cancelAnimationFrame(hackLoopRef);
            }

            function hackLoop() {
                if(!hacking) return;
                hackPos += hackDir;
                if(hackPos > 100 || hackPos < 0) hackDir *= -1;
                document.getElementById('h-cursor').style.left = hackPos + '%';
                hackLoopRef = requestAnimationFrame(hackLoop);
            }

            // --- ACTIONS ---
            // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –¥–ª—è HTML –∫–Ω–æ–ø–æ–∫
            window.action = function(act) {
                playSound('UI');
                
                if(state.neon < 25) {
                    notify("‚ö†Ô∏è LOW POWER. RECHARGE REQUIRED.", "#ffcc00"); 
                    tg.sendData(JSON.stringify({act:'buy_neon'})); 
                    return;
                }

                if(act === 'gacha') {
                    startHack(); // Trigger Minigame first!
                } 
                else if (act === 'fuse') {
                    notify("üß¨ INITIATING FUSION PROTOCOL...", "#bd00ff");
                    tg.sendData(JSON.stringify({act: 'fuse'}));
                }
            }

            function notify(text, color) {
                const el = document.getElementById('notif');
                const box = document.getElementById('notif-text');
                box.innerText = text;
                box.style.borderColor = color || "#00ffcc";
                box.style.color = color || "#00ffcc";
                
                el.style.opacity = 1;
                el.style.transform = 'translateY(0)';
                
                setTimeout(() => {
                    el.style.opacity = 0;
                    el.style.transform = 'translateY(20px)';
                }, 2000);
            }

        })();
    </script>
</body>
</html>
